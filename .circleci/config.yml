version: 2.1

_run:
  up-containers: &up-containers
    name: 'Up containers'
    command: |
      echo "MAGENTO_VERSION=$MAGENTO_VERSION" >> .env
      echo "IMGUR_CLIENT_ID=$IMGUR_CLIENT_ID" >> .env
      docker-compose up -d
      magentoIsInstalled() {
        isInstalled=$(docker-compose exec magento php -f install.php | grep "Magento is already installed" | wc -l)

        if [ $isInstalled -eq 1 ] 
        then
          return 0
        else
          return 1
        fi
      }
      while ! ( magentoIsInstalled )
      do
        echo [$(date +"%Y-%m-%d %H:%M:%S")] - "Waiting for magento to be installed..."
        sleep 15
      done
  dump-autoload: &dump-autoload
    name: 'Dump composer autoload'
    command: 'docker-compose run composer dump-autoload'

jobs:
  checkout-code:
    machine:
      enabled: true
    steps:
      - checkout
      - persist_to_workspace:
            root: ~/project
            paths:
              - ./

  forgotten-keys:
    machine:
      enabled: true
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: 'Avoid forgotten keys'
          command: 'chmod +x ./forgotten_keys.sh && ./forgotten_keys.sh'

  unit:
    machine:
      enabled: true
    steps:
      - attach_workspace:
          at: ~/project
      - run: *up-containers
      - run: *dump-autoload
      - run:
          name: 'Running unit tests'
          command: 'docker-compose exec magento vendor/bin/phpunit'

  end-to-end:
    description: Parameterized job to run end-to-end suites
    parameters:
      suite_name:
        description: "the suite name to be ran"
        type: string
      magento_version:
        description: "Magento version to be used"
        type: string
        default: "1.8.1.0"
    machine:
      enabled: true
    environment:
      MAGENTO_VERSION: << parameters.magento_version >>
    steps:
      - attach_workspace:
          at: ~/project
      - run: *up-containers
      - run: *dump-autoload
      - run:
          name: Running << parameters.suite_name >> end to end suite test
          command: docker-compose exec magento vendor/bin/behat -s << parameters.suite_name >> --stop-on-failure
      - run:
          name: Show magento's system and error logs
          when: on_fail
          command: |
            docker-compose exec magento cat var/log/system.log
            docker-compose exec magento cat var/log/exception.log

workflows:
  version: 2
  tests:
    jobs:
      - checkout-code
      - forgotten-keys:
          requires:
          - checkout-code
      - unit:
          requires:
            - forgotten-keys
      - end-to-end:
          name: e2e-configure-mage-1.8
          suite_name: "configure"
          magento_version: "1.8.1.0"
          requires:
            - forgotten-keys
      - end-to-end:
          name: e2e-credit_card-mage-1.8
          suite_name: "credit_card"
          magento_version: "1.8.1.0"
          requires:
            - forgotten-keys
      - end-to-end:
          name: e2e-boleto-mage-1.8
          suite_name: "boleto"
          magento_version: "1.8.1.0"
          requires:
            - forgotten-keys
      - end-to-end:
          name: e2e-postback-mage-1.8
          suite_name: "postback"
          magento_version: "1.8.1.0"
          requires:
            - forgotten-keys
      - end-to-end:
          name: e2e-configure-mage-1.7
          suite_name: "configure"
          magento_version: "1.7.0.2"
          requires:
            - forgotten-keys
      - end-to-end:
          name: e2e-credit_card-mage-1.7
          suite_name: "credit_card"
          magento_version: "1.7.0.2"
          requires:
            - forgotten-keys
      - end-to-end:
          name: e2e-boleto-mage-1.7
          suite_name: "boleto"
          magento_version: "1.7.0.2"
          requires:
            - forgotten-keys
      - end-to-end:
          name: e2e-postback-mage-1.7
          suite_name: "postback"
          magento_version: "1.7.0.2"
          requires:
            - forgotten-keys
      - end-to-end:
          name: e2e-configure-mage-1.9
          suite_name: "configure"
          magento_version: "1.9.1.0"
          requires:
            - forgotten-keys
      - end-to-end:
          name: e2e-credit_card-mage-1.9
          suite_name: "credit_card"
          magento_version: "1.9.1.0"
          requires:
            - forgotten-keys
      - end-to-end:
          name: e2e-boleto-mage-1.9
          suite_name: "boleto"
          magento_version: "1.9.1.0"
          requires:
            - forgotten-keys
      - end-to-end:
          name: e2e-postback-mage-1.9
          suite_name: "postback"
          magento_version: "1.9.1.0"
          requires:
            - forgotten-keys